<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.spring.silli.quiz.mapper.QuizMapper">

<insert id="faile_insert" parameterType="kr.spring.silli.quiz.vo.QuestionVO">
		
		<choose>
			<when test="user_id != null">
			<![CDATA[
			INSERT INTO 
				fail_list
					(question
					,answer
					,user_id) 
				values (#{question}
						,#{answer}
						,#{user_id})
				ON DUPLICATE KEY
				UPDATE 
					question = #{question}
					,answer = #{answer}
					,user_id=#{user_id}
			]]>
			</when>
			<otherwise>
			<![CDATA[
			INSERT INTO 
				fail_list
					(question
					,answer
					,user_id
					) 
				values (#{question}
						,#{answer}
						,"visitant"
						)
				ON DUPLICATE KEY
				UPDATE 
					question = #{question}
					,answer = #{answer}
					,user_id = "visitant"
			]]>
			</otherwise>
		</choose>
	</insert>
	
	
	<delete id="faile_del" parameterType="kr.spring.silli.quiz.vo.faileVO">
	<![CDATA[
		delete 
			from fail_list
	]]>
	<choose>
		<when test="user_id != null">
		<![CDATA[
		where 
			question=#{question}
			AND
			user_id=#{user_id}
		]]>
		</when>
		<otherwise>
		<![CDATA[
		where 
			question=#{question} 
			AND
			user_id="visitant"
		]]>		
		</otherwise>
	</choose>
	</delete>
	
	<select id="faile_chk" parameterType="kr.spring.silli.quiz.vo.QuestionVO" resultType="kr.spring.silli.quiz.vo.QuestionVO">
		<![CDATA[
			select
				question,
				answer
			from
				fail_list
		]]>
		<choose>
		<when test="user_id !=null">
		<![CDATA[
		where 
			user_id=#{user_id} 
				order by rand()
		]]>
		</when>
		<otherwise>
		<![CDATA[
		where 
			user_id="visitant"
				order by rand()
		]]>		
		</otherwise>
	</choose>
	</select>
	
	<select id="chk" parameterType="kr.spring.silli.quiz.vo.QuestionVO" resultType="kr.spring.silli.quiz.vo.QuestionVO">
	<![CDATA[
		select question
			   ,answer
			   ,user_id 
		from quiz 
		where(
			question
			,answer
			,user_id
			) 
			not in(
				select question
						,answer
						,user_id 
				from ans ) AND user_id="visitant" order by rand()
		]]>	
		
	</select>
	
	<select id="requiz" parameterType="kr.spring.silli.quiz.vo.QuestionVO" resultType="kr.spring.silli.quiz.vo.QuestionVO">
	<choose>
		<when test="user_id != null">
		<![CDATA[
		select question
			   ,answer
			   ,user_id 
		from quiz 
		where(
			question
			,answer
			,user_id
			) 
			not in(
				select question
						,answer
						,user_id 
				from ans ) AND user_id=#{user_id} order by rand()
		]]>
		</when>
		<otherwise>
			<![CDATA[
		select question
			   ,answer
			   ,user_id 
		from quiz 
		where(
			question
			,answer
			,user_id
			) 
			not in(
				select question
						,answer
						,user_id 
				from ans ) AND user_id="visitant" order by rand()
		]]>
		</otherwise>
		</choose>
	</select>
	
	<delete id="quiz_del" parameterType="kr.spring.silli.quiz.vo.QuestionVO">
	<![CDATA[
		delete 
			from quiz
		where questoin IN
			<foreach collection="list" item="item" index="i" open="(" separator="," close=")">
		      #{item}
		    </foreach>
		]]>
	</delete>
	
	<delete id="ans_del" parameterType="kr.spring.silli.quiz.vo.QuestionVO">
		<choose>
		 <when test="user_id != null">
		<![CDATA[
			delete 
			from
				ans
			where 
				user_id=#{user_id}	
		]]>
		</when>
		<otherwise>
		<![CDATA[
		delete 
			from
				ans
			where 
				user_id="visitant"
		]]>
		</otherwise>
		</choose>
	</delete>
	
	<insert id="ans_ins" parameterType="kr.spring.silli.quiz.vo.QuestionVO">
		<choose>
			<when test="user_id != null">
		<![CDATA[
			insert into 
				ans(
					question
					,answer
					,user_id)
				values(
					#{question}
					,#{answer}
					,#{user_id}
					)
		]]>
		</when>
		<otherwise>
		<![CDATA[
			insert into 
				ans(
					question
					,answer
					,user_id)
				values(
					#{question}
					,#{answer}
					,"visitant"
					)
		]]>				
		
		</otherwise>
		</choose>
	</insert>
	
	<insert id="quiz_write" parameterType="kr.spring.silli.quiz.vo.QuestionVO">
		<![CDATA[
			insert into
				quiz
					(
					question
					,answer
					,user_id
					)
				values
					(
					#{question}
					,#{answer}
					,#{user_id}
					)
		]]>
	</insert>
</mapper>